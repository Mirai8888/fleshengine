<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>人肉搜索</title>
<meta name="description" content="You were not supposed to find this.">
<style>
body {
  background: #2a1408;
  color: #e8d5b5;
  font-family: 'Trebuchet MS', Verdana, Arial, sans-serif;
  font-size: 13px;
  line-height: 1.5;
  margin: 0;
  padding: 0;
}
a { color: #d4a76a; }
a:visited { color: #b8894a; }
a:hover { text-decoration: underline; }
hr { border: none; border-top: 1px solid #4a2a10; margin: 12px 0; }

#wrapper {
  width: 760px;
  margin: 0 auto;
  padding: 0;
}
#header {
  background: #1a0a02;
  border-bottom: 2px solid #6b4420;
  padding: 16px 20px;
}
#header h1 {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 28px;
  font-weight: normal;
  color: #c8a060;
  margin: 0;
  letter-spacing: 4px;
}
#header .subtitle {
  font-size: 12px;
  color: #8a6a3a;
  margin-top: 2px;
}
#nav {
  background: #3a1a08;
  border-bottom: 1px solid #4a2a10;
  padding: 4px 20px;
  font-size: 11px;
}
#nav a {
  color: #a07840;
  margin-right: 12px;
  text-decoration: none;
}
#nav a:hover { color: #e8d5b5; }

#content {
  padding: 16px 20px;
}
#sidebar {
  float: right;
  width: 220px;
  padding-left: 16px;
}
#main {
  margin-right: 240px;
  overflow: hidden;
}

h2 {
  font-family: Georgia, serif;
  font-size: 15px;
  font-weight: bold;
  color: #c8a060;
  border-bottom: 1px solid #4a2a10;
  padding-bottom: 4px;
  margin: 16px 0 8px 0;
}
h3 {
  font-size: 13px;
  font-weight: bold;
  color: #a07840;
  margin: 10px 0 4px 0;
}

/* SUBMIT */
#submit-box {
  background: #1a0a02;
  border: 1px solid #4a2a10;
  padding: 12px;
  margin-bottom: 14px;
}
#submit-box .prompt {
  font-size: 11px;
  color: #6b4420;
  margin-bottom: 6px;
  font-style: italic;
}
#submit-box input[type="text"] {
  font-family: 'Courier New', monospace;
  font-size: 13px;
  background: #0e0600;
  color: #e8d5b5;
  border: 1px solid #6b4420;
  padding: 6px 8px;
  width: 380px;
}
#submit-box input[type="submit"] {
  font-family: Verdana, sans-serif;
  font-size: 11px;
  background: #3a1a08;
  color: #c8a060;
  border: 1px solid #6b4420;
  padding: 6px 14px;
  cursor: pointer;
}
#submit-box input[type="submit"]:hover {
  background: #4a2a10;
}
#submit-status {
  display: none;
  margin-top: 8px;
  padding: 6px 8px;
  font-size: 12px;
  border: 1px solid #4a2a10;
  background: #1a0a02;
}
.status-ok { color: #7a9a4a; }
.status-err { color: #a04030; }
.status-info { color: #a07840; }

/* PROFILE LIST */
table.profiles {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  table-layout: fixed;
}
table.profiles th {
  background: #1a0a02;
  color: #a07840;
  text-align: left;
  padding: 4px 6px;
  border: 1px solid #4a2a10;
  font-size: 11px;
  font-weight: bold;
}
table.profiles th:nth-child(1) { width: 25%; }
table.profiles th:nth-child(2) { width: 8%; }
table.profiles th:nth-child(3) { width: 30%; }
table.profiles th:nth-child(4) { width: 15%; }
table.profiles th:nth-child(5) { width: 22%; }
table.profiles td {
  padding: 4px 6px;
  border: 1px solid #3a1a08;
  vertical-align: top;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
table.profiles tr:hover {
  background: #1a0a02;
}
table.profiles a { text-decoration: none; }
.score-high { color: #c04030; font-weight: bold; }
.score-med { color: #c89030; }
.score-low { color: #8a6a3a; }

/* FRAGMENTS */
.fragment {
  border-left: 2px solid #4a2a10;
  padding: 4px 0 4px 10px;
  margin: 6px 0;
  font-size: 12px;
}
.fragment .meta {
  color: #6b4420;
  font-family: 'Courier New', monospace;
  font-size: 10px;
}
.fragment .body {
  color: #c8a060;
  font-style: italic;
  margin: 2px 0;
}
.fragment .conf {
  font-size: 10px;
  color: #6b4420;
  text-transform: uppercase;
}

/* SIDEBAR */
.sidebar-box {
  background: #1a0a02;
  border: 1px solid #4a2a10;
  padding: 8px 10px;
  margin-bottom: 10px;
  font-size: 11px;
}
.sidebar-box h3 {
  font-size: 11px;
  color: #c8a060;
  margin: 0 0 6px 0;
  border-bottom: 1px solid #3a1a08;
  padding-bottom: 3px;
}
.sidebar-box .stat-num {
  font-family: Georgia, serif;
  font-size: 20px;
  color: #c8a060;
  display: block;
}
.sidebar-box .stat-label {
  font-size: 10px;
  color: #6b4420;
}

#footer {
  background: #1a0a02;
  border-top: 1px solid #4a2a10;
  padding: 8px 20px;
  font-size: 10px;
  color: #4a2a10;
  text-align: center;
  margin-top: 16px;
}

/* PIPELINE */
table.pipeline {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  margin: 8px 0;
}
table.pipeline td {
  padding: 6px 8px;
  border: 1px solid #3a1a08;
  vertical-align: top;
}
table.pipeline td.num {
  width: 24px;
  text-align: center;
  font-family: Georgia, serif;
  font-size: 14px;
  color: #c8a060;
  background: #1a0a02;
}
table.pipeline td.step {
  color: #a07840;
  font-weight: bold;
  width: 140px;
}

.clear { clear: both; }
</style>
</head>
<body>

<div id="wrapper">

<div id="header">
  <h1>人肉搜索</h1>
  <div class="subtitle">FLESHENGINE &mdash; the flesh remembers what the profile deletes</div>
</div>

<div id="nav">
  <a href="index.html">Home</a>
  <a href="scanner.html">Scanner</a>
  <a href="about.html">About</a>
  <a href="https://github.com/Mirai8888/fleshengine">Source</a>
</div>

<div id="content">

<div id="sidebar">

  <div class="sidebar-box">
    <h3>Database</h3>
    <span class="stat-num" id="stat-targets">&mdash;</span>
    <span class="stat-label">targets indexed</span>
    <br><br>
    <span class="stat-num" id="stat-fragments">&mdash;</span>
    <span class="stat-label">fragments collected</span>
  </div>

  <div class="sidebar-box">
    <h3>Pipeline</h3>
    <table class="pipeline">
      <tr><td class="num">1</td><td class="step">Submit</td><td>A handle. A URL. A name they thought they buried.</td></tr>
      <tr><td class="num">2</td><td class="step">Extract</td><td>Automated public data collection</td></tr>
      <tr><td class="num">3</td><td class="step">Map</td><td>12-vector vulnerability assessment</td></tr>
      <tr><td class="num">4</td><td class="step">Collect</td><td>Human observers contribute fragments</td></tr>
      <tr><td class="num">5</td><td class="step">Profile</td><td>Composite intelligence brief</td></tr>
    </table>
  </div>

  <div class="sidebar-box">
    <h3>Recent Activity</h3>
    <div id="sidebar-activity"><span style="color:#6b4420; font-style:italic">Waiting.</span></div>
  </div>

</div>

<div id="main">

  <h2>Submit Target</h2>

  <div id="submit-box">
    <div class="prompt">Someone you need to understand. Someone who operates in public and thinks the patterns are invisible.</div>
    <form id="submit-form" onsubmit="submitTarget(event)">
      <input type="text" id="target-input" placeholder="@handle or URL" autofocus>
      <input type="submit" value="Submit">
    </form>
    <div id="submit-status"></div>
  </div>

  <h2>Indexed Targets</h2>

  <table class="profiles" id="profiles-table">
    <tr>
      <th>Target</th>
      <th>Score</th>
      <th>Vectors</th>
      <th>Fragments</th>
      <th>Status</th>
    </tr>
  </table>
  <div id="profiles-empty" style="color:#6b4420; font-size:12px; padding:8px 0; font-style:italic;">No targets indexed yet. The database is patient.</div>

  <h2>Recent Fragments</h2>

  <div id="fragments-list">
    <div style="color:#6b4420; font-size:12px; font-style:italic;">No fragments collected. Someone will talk eventually.</div>
  </div>

</div>

<div class="clear"></div>
</div>

<div id="footer">
  人肉搜索 // FLESHENGINE // the crowd sees what the algorithm misses<br>
  &copy; 2024-2026
</div>

</div>

<script>
const API = 'https://kwrrdptfpqgiwktbgefb.supabase.co/rest/v1';
const KEY = 'sb_publishable_uRPJlC4dcLKvbGKLMp8u1g_FkIQH6Or';
const H = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

async function q(path, opts) {
  const r = await fetch(API + path, { headers: H, ...opts });
  if (!r.ok) throw new Error(r.statusText);
  const ct = r.headers.get('content-type');
  if (ct && ct.includes('json')) return r.json();
  return null;
}

async function submitTarget(e) {
  e.preventDefault();
  const input = document.getElementById('target-input');
  const status = document.getElementById('submit-status');
  let val = input.value.trim();
  if (!val) return;
  val = val.replace(/^https?:\/\/(www\.)?(twitter|x)\.com\//, '').replace(/^@/, '').replace(/\/.*$/, '');
  if (!val) return;

  status.style.display = 'block';
  status.className = 'status-info';
  status.textContent = 'Submitting...';

  try {
    const existing = await q('/targets?handle=eq.' + encodeURIComponent(val.toLowerCase()) + '&select=id&limit=1');
    if (existing && existing.length) {
      status.className = 'status-info';
      status.innerHTML = 'Already indexed. <a href="profile.html?t=' + existing[0].id + '">View profile &rarr;</a>';
      input.value = '';
      return;
    }
    const data = await q('/targets', {
      method: 'POST',
      body: JSON.stringify({ handle: val.toLowerCase(), display_handle: val, status: 'queued' })
    });
    status.className = 'status-ok';
    status.innerHTML = 'Queued. <a href="profile.html?t=' + data[0].id + '">Watch it build &rarr;</a>';
    input.value = '';
    loadProfiles();
    loadStats();
  } catch (err) {
    status.className = 'status-err';
    status.textContent = 'Error: ' + (err.message || 'Submission failed.');
  }
}

async function loadProfiles() {
  try {
    const data = await q('/targets?select=*&order=created_at.desc&limit=30');
    if (!data || !data.length) return;
    document.getElementById('profiles-empty').style.display = 'none';
    const table = document.getElementById('profiles-table');
    while (table.rows.length > 1) table.deleteRow(1);
    data.forEach(t => {
      const row = table.insertRow();
      const sc = t.threat_score;
      const scClass = sc >= 70 ? 'score-high' : sc >= 40 ? 'score-med' : 'score-low';
      row.innerHTML = '<td><a href="profile.html?t=' + t.id + '">@' + (t.display_handle||t.handle) + '</a></td>' +
        '<td class="' + scClass + '">' + (sc != null ? sc : '&mdash;') + '</td>' +
        '<td style="color:#8a6a3a;font-size:11px">' + (t.top_vectors || '&mdash;') + '</td>' +
        '<td>' + (t.fragment_count || 0) + '</td>' +
        '<td style="font-size:11px;color:' + (t.status==='active'?'#7a9a4a':'#8a6a3a') + '">' + (t.status||'queued').toUpperCase() + '</td>';
    });
  } catch(e) { console.error(e); }
}

async function loadFragments() {
  try {
    const data = await q('/fragments?select=*&order=created_at.desc&limit=10');
    if (!data || !data.length) return;
    const list = document.getElementById('fragments-list');
    list.innerHTML = '';
    data.forEach(f => {
      const ts = new Date(f.created_at).toISOString().replace('T',' ').substring(0,19);
      list.innerHTML += '<div class="fragment">' +
        '<div class="meta">[' + ts + '] ' + f.observation_type + ' &rarr; @' + f.target_handle + '</div>' +
        '<div class="body">"' + f.body + '"</div>' +
        '<div class="conf">confidence: ' + (f.confidence||'medium') + '</div></div>';
    });
  } catch(e) { console.error(e); }
}

async function loadStats() {
  try {
    const tr = await fetch(API + '/targets?select=id', { headers: { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Prefer': 'count=exact' } });
    const fr = await fetch(API + '/fragments?select=id', { headers: { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Prefer': 'count=exact' } });
    const parseCount = (r) => { const cr = r.headers.get('content-range'); if (!cr) return 0; const m = cr.match(/\/(\d+)/); return m ? parseInt(m[1]) : 0; };
    document.getElementById('stat-targets').textContent = parseCount(tr);
    document.getElementById('stat-fragments').textContent = parseCount(fr);
  } catch(e) {
    document.getElementById('stat-targets').textContent = '?';
    document.getElementById('stat-fragments').textContent = '?';
  }
}

async function loadRecent() {
  try {
    const data = await q('/targets?select=display_handle,created_at&order=created_at.desc&limit=5');
    if (!data || !data.length) return;
    const el = document.getElementById('sidebar-activity');
    el.innerHTML = data.map(t => {
      const ago = Math.floor((Date.now() - new Date(t.created_at).getTime()) / 60000);
      const when = ago < 60 ? ago + 'm ago' : Math.floor(ago/60) + 'h ago';
      return '<div style="padding:1px 0;">@' + t.display_handle + ' <span style="color:#4a2a10">' + when + '</span></div>';
    }).join('');
  } catch(e) {}
}

loadProfiles();
loadFragments();
loadStats();
loadRecent();
</script>
</body>
</html>
