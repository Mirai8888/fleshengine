<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLESHENGINE — Target Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #2a1408; --bg-deep: #1e0e05; --bg-card: #38160d;
  --text: #fee6cf; --text-dim: #c8882a;
  --gold: #bd965d; --gold-bright: #cca800; --gold-dark: #a57125;
  --link: #db956a; --link-visited: #c8882a;
  --border: #907e2f; --border-dim: #5a3a1a;
  --green: #6b8a3d; --warn: #c87830; --crit: #a83020;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'EB Garamond', Georgia, serif; font-size: 18px; line-height: 1.6; background: var(--bg); color: var(--text); }
a { color: var(--link); text-decoration: none; }
a:visited { color: var(--link-visited); }
a:hover { color: var(--text); }
.container { max-width: 860px; margin: 0 auto; padding: 28px; }
hr { border: 0; border-top: 1px solid var(--border-dim); margin: 32px 0; }
h1 { font-family: 'Cinzel', serif; font-size: 24px; font-weight: 700; letter-spacing: 4px; color: var(--gold); }
h1 .handle { font-family: 'Courier New', monospace; color: var(--text); }
h2 { font-family: 'Cinzel', serif; font-size: 16px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--gold); margin-bottom: 18px; padding-bottom: 8px; border-bottom: 1px solid var(--border-dim); }
.nav { font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 2px; text-transform: uppercase; }
.nav a { color: var(--gold-dark); margin-right: 10px; }
.nav a:hover { color: var(--gold); }

.meta-card { background: var(--bg-card); border: 1px solid var(--border); padding: 20px 24px; display: grid; grid-template-columns: 1fr auto; gap: 20px; }
.meta-rows { display: grid; gap: 8px; }
.meta-row { display: flex; gap: 14px; font-size: 16px; }
.meta-label { color: var(--gold-dark); min-width: 140px; }
.meta-value { color: var(--text); }
.meta-value.active { color: var(--green); }
.score-box { text-align: center; }
.score-num { font-family: 'Cinzel', serif; font-size: 52px; font-weight: 700; color: var(--gold-bright); line-height: 1; }
.score-label { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--gold-dark); margin-top: 4px; }

.vuln-grid { display: grid; gap: 8px; }
.vuln-row { display: grid; grid-template-columns: 220px 1fr 44px; gap: 14px; align-items: center; font-size: 15px; }
.vuln-code { color: var(--gold-dark); font-family: 'Courier New', monospace; font-size: 12px; }
.vuln-name { color: var(--text-dim); }
.vuln-bar-outer { background: var(--bg-deep); height: 16px; border: 1px solid var(--border-dim); }
.vuln-bar-inner { height: 100%; transition: width 0.5s; }
.vuln-score { color: var(--text); text-align: right; font-size: 14px; font-weight: 600; }
.bar-low { background: var(--border-dim); }
.bar-med { background: var(--warn); }
.bar-high { background: var(--gold-bright); }
.bar-crit { background: #a83020; }

.fragment { background: var(--bg-card); border: 1px solid var(--border-dim); border-left: 3px solid var(--border); padding: 14px 18px; margin-bottom: 12px; }
.fragment-header { font-size: 12px; color: var(--gold-dark); font-family: 'Courier New', monospace; margin-bottom: 6px; }
.fragment-body { font-size: 16px; color: var(--text-dim); font-style: italic; line-height: 1.5; }
.fragment-confidence { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-top: 8px; }
.conf-high { color: var(--gold-bright); }
.conf-medium { color: var(--gold-dark); }
.conf-low { color: var(--border); }

.contribute-form { background: var(--bg-card); border: 1px solid var(--border-dim); padding: 20px 24px; }
.form-row { display: grid; grid-template-columns: 120px 1fr; gap: 14px; margin-bottom: 12px; align-items: start; }
.form-label { font-size: 13px; color: var(--gold-dark); text-transform: uppercase; letter-spacing: 1px; padding-top: 10px; }
textarea, input[type="url"], input[type="text"], select {
  font-family: 'Courier New', monospace; font-size: 15px;
  background: var(--bg-deep); color: var(--text);
  border: 1px solid var(--border-dim); padding: 10px 12px; width: 100%;
}
textarea { resize: vertical; }
select { width: auto; min-width: 220px; }
textarea:focus, input:focus, select:focus { outline: none; border-color: var(--gold); }
input[type="submit"] {
  font-family: 'Cinzel', serif; font-size: 12px; font-weight: 700;
  background: var(--border-dim); color: var(--gold);
  border: 1px solid var(--border); padding: 12px 24px;
  cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
}
input[type="submit"]:hover { background: var(--gold); color: var(--bg-deep); }
#frag-msg { display: none; font-size: 15px; padding: 14px; background: var(--bg-deep); border: 1px solid var(--border-dim); margin-top: 14px; }
#frag-msg.success { color: var(--green); border-color: var(--green); }
#frag-msg.error { color: #a83020; border-color: #a83020; }

.assessment { background: var(--bg-card); border: 1px solid var(--border); padding: 20px 24px; font-size: 17px; line-height: 1.7; color: var(--text-dim); }
.assessment strong { color: var(--text); }

.empty-state { background: var(--bg-card); border: 1px solid var(--border-dim); padding: 36px 28px; text-align: center; color: var(--gold-dark); font-style: italic; font-size: 17px; }
.footer { font-size: 13px; color: var(--border-dim); font-style: italic; }

@media (max-width: 600px) {
  .meta-card { grid-template-columns: 1fr; }
  .vuln-row { grid-template-columns: 1fr; gap: 4px; }
  .form-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">

<div class="nav">
[ <a href="index.html">Home</a> ]
[ Profile ]
[ <a href="scanner.html">Scanner</a> ]
[ <a href="about.html">About</a> ]
</div>

<hr>

<h1>TARGET: <span class="handle" id="target-handle">Loading...</span></h1>

<br>

<div class="meta-card" id="meta-card">
  <div class="meta-rows">
    <div class="meta-row"><span class="meta-label">Status</span><span class="meta-value" id="meta-status">—</span></div>
    <div class="meta-row"><span class="meta-label">Fragments</span><span class="meta-value" id="meta-fragments">0</span></div>
    <div class="meta-row"><span class="meta-label">Contributors</span><span class="meta-value" id="meta-contributors">0</span></div>
    <div class="meta-row"><span class="meta-label">Submitted</span><span class="meta-value" id="meta-created">—</span></div>
    <div class="meta-row"><span class="meta-label">Last Update</span><span class="meta-value" id="meta-updated">—</span></div>
  </div>
  <div class="score-box">
    <div class="score-num" id="meta-score">—</div>
    <div class="score-label">Threat Score</div>
  </div>
</div>

<hr>

<h2>Influence Vulnerability Surface</h2>

<div class="vuln-grid" id="vuln-grid"></div>

<hr>

<h2>Intelligence Fragments</h2>

<div id="fragments-container">
  <div class="empty-state" id="fragments-empty">No fragments submitted yet for this target.</div>
  <div id="fragments-list" style="display:none"></div>
</div>

<hr>

<h2>Contribute Observation</h2>

<div class="contribute-form">
<form id="fragment-form" onsubmit="submitFragment(event)">
  <input type="hidden" id="frag-target-id" value="">
  <input type="hidden" id="frag-target-handle" value="">
  <div class="form-row"><span class="form-label">Type</span>
    <select id="obs-type">
      <option value="behavioral_pattern">Behavioral Pattern</option>
      <option value="relationship_dynamic">Relationship Dynamic</option>
      <option value="narrative_shift">Narrative Shift</option>
      <option value="tone_analysis">Tone Analysis</option>
      <option value="network_activity">Network Activity</option>
      <option value="other">Other</option>
    </select>
  </div>
  <div class="form-row"><span class="form-label">Observation</span><textarea id="obs-text" rows="4" maxlength="1000" placeholder="Describe what you observed"></textarea></div>
  <div class="form-row"><span class="form-label">Evidence</span><input type="url" id="obs-evidence" placeholder="Link to specific post or content (optional)"></div>
  <div class="form-row"><span class="form-label">Timeframe</span><input type="text" id="obs-time" placeholder="When was this observed (optional)"></div>
  <div class="form-row"><span class="form-label">Confidence</span>
    <select id="obs-conf">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
    </select>
  </div>
  <div style="margin-top:16px"><input type="submit" value="Submit Fragment"></div>
</form>
<div id="frag-msg"></div>
</div>

<hr>

<h2>Assessment</h2>

<div class="assessment" id="assessment">
  <em style="color:var(--gold-dark)">Assessment will be generated once sufficient data has been collected.</em>
</div>

<hr>

<div class="nav">
[ <a href="index.html">Home</a> ]
[ Profile ]
[ <a href="scanner.html">Scanner</a> ]
[ <a href="about.html">About</a> ]
</div>

<hr>
<div class="footer">人肉搜索 // FLESHENGINE</div>

</div>

<script>
const SUPABASE_URL = 'https://kwrrdptfpqgiwktbgefb.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_uRPJlC4dcLKvbGKLMp8u1g_FkIQH6Or';
let supabase = null;

const FE_CODES = [
  { code: 'FE-001', name: 'Narrative Framing' },
  { code: 'FE-002', name: 'Repetition Saturation' },
  { code: 'FE-003', name: 'Audience Conditioning' },
  { code: 'FE-004', name: 'Loyalty Exploitation' },
  { code: 'FE-005', name: 'Identity Manipulation' },
  { code: 'FE-006', name: 'Manufactured Consensus' },
  { code: 'FE-007', name: 'Viral Propagation' },
  { code: 'FE-008', name: 'Urgency Fabrication' },
  { code: 'FE-009', name: 'Attention Redirection' },
  { code: 'FE-010', name: 'Reality Distortion' },
  { code: 'FE-011', name: 'Cognitive Overload' },
  { code: 'FE-012', name: 'Existential Threat Framing' },
];

function barClass(val) {
  if (val >= 80) return 'bar-crit';
  if (val >= 55) return 'bar-med';
  if (val >= 30) return 'bar-low';
  return 'bar-low';
}

function renderVulnGrid(target) {
  const grid = document.getElementById('vuln-grid');
  grid.innerHTML = '';
  FE_CODES.forEach((fe, i) => {
    const key = 'fe_' + String(i + 1).padStart(3, '0');
    const val = target[key] || 0;
    grid.innerHTML += `
      <div class="vuln-row">
        <div><span class="vuln-code">${fe.code}</span> <span class="vuln-name">${fe.name}</span></div>
        <div class="vuln-bar-outer"><div class="vuln-bar-inner ${barClass(val)}" style="width:${val}%"></div></div>
        <div class="vuln-score">${val}</div>
      </div>`;
  });
}

function fmtDate(d) {
  if (!d) return '—';
  return new Date(d).toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
}

async function loadProfile() {
  const params = new URLSearchParams(window.location.search);
  const targetId = params.get('t');

  if (!targetId) {
    document.getElementById('target-handle').textContent = 'No target specified';
    return;
  }

  if (!supabase) {
    document.getElementById('target-handle').textContent = 'Database not connected';
    return;
  }

  try {
    const { data: target, error } = await supabase
      .from('targets')
      .select('*')
      .eq('id', targetId)
      .single();

    if (error || !target) {
      document.getElementById('target-handle').textContent = 'Target not found';
      return;
    }

    // Set page title
    document.title = 'FLESHENGINE — @' + (target.display_handle || target.handle);
    document.getElementById('target-handle').textContent = '@' + (target.display_handle || target.handle);

    // Meta card
    const statusEl = document.getElementById('meta-status');
    statusEl.textContent = (target.status || 'queued').toUpperCase();
    if (target.status === 'active') statusEl.classList.add('active');
    document.getElementById('meta-fragments').textContent = target.fragment_count || 0;
    document.getElementById('meta-contributors').textContent = target.contributor_count || 0;
    document.getElementById('meta-created').textContent = fmtDate(target.created_at);
    document.getElementById('meta-updated').textContent = fmtDate(target.updated_at);
    document.getElementById('meta-score').textContent = target.threat_score != null ? target.threat_score : '—';

    // Vulnerability grid
    renderVulnGrid(target);

    // Assessment
    if (target.assessment) {
      document.getElementById('assessment').innerHTML = target.assessment;
    }

    // Fragment form hidden fields
    document.getElementById('frag-target-id').value = target.id;
    document.getElementById('frag-target-handle').value = target.handle;

    // Load fragments
    loadFragments(target.id);

  } catch (err) {
    console.error(err);
    document.getElementById('target-handle').textContent = 'Error loading profile';
  }
}

async function loadFragments(targetId) {
  try {
    const { data, error } = await supabase
      .from('fragments')
      .select('*')
      .eq('target_id', targetId)
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) throw error;
    if (!data || data.length === 0) return;

    document.getElementById('fragments-empty').style.display = 'none';
    const list = document.getElementById('fragments-list');
    list.style.display = 'block';
    list.innerHTML = '';

    data.forEach(f => {
      const ts = fmtDate(f.created_at);
      const el = document.createElement('div');
      el.className = 'fragment';
      el.innerHTML = `
        <div class="fragment-header">[${ts}] ${f.observation_type}</div>
        <div class="fragment-body">"${f.body}"</div>
        ${f.evidence_url ? '<div style="font-size:13px;margin-top:4px"><a href="' + f.evidence_url + '">Evidence link</a></div>' : ''}
        <div class="fragment-confidence conf-${f.confidence || 'medium'}">Confidence: ${(f.confidence || 'medium').toUpperCase()}</div>
      `;
      list.appendChild(el);
    });
  } catch (err) {
    console.error('Failed to load fragments:', err);
  }
}

async function submitFragment(e) {
  e.preventDefault();
  const msg = document.getElementById('frag-msg');
  const targetId = document.getElementById('frag-target-id').value;
  const targetHandle = document.getElementById('frag-target-handle').value;
  const body = document.getElementById('obs-text').value.trim();

  if (!body) { msg.className = 'error'; msg.style.display = 'block'; msg.textContent = 'Observation text is required.'; return; }
  if (!targetId) { msg.className = 'error'; msg.style.display = 'block'; msg.textContent = 'No target loaded.'; return; }

  if (!supabase) {
    msg.className = 'error'; msg.style.display = 'block'; msg.textContent = 'Database not connected.'; return;
  }

  msg.style.display = 'block'; msg.className = ''; msg.textContent = 'Submitting...';

  try {
    const { error } = await supabase.from('fragments').insert({
      target_id: targetId,
      target_handle: targetHandle,
      observation_type: document.getElementById('obs-type').value,
      body: body,
      evidence_url: document.getElementById('obs-evidence').value.trim() || null,
      timeframe: document.getElementById('obs-time').value.trim() || null,
      confidence: document.getElementById('obs-conf').value,
    });

    if (error) throw error;

    msg.className = 'success';
    msg.textContent = 'Fragment submitted. Thank you for your contribution.';
    document.getElementById('obs-text').value = '';
    document.getElementById('obs-evidence').value = '';
    document.getElementById('obs-time').value = '';
    loadFragments(targetId);
  } catch (err) {
    msg.className = 'error';
    msg.textContent = 'Error: ' + (err.message || 'Failed to submit fragment.');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  if (SUPABASE_URL && SUPABASE_ANON_KEY) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
    script.onload = () => {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      loadProfile();
    };
    document.head.appendChild(script);
  } else {
    document.getElementById('target-handle').textContent = 'Database not configured';
  }
});
</script>
</body>
</html>
