<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>人肉搜索 — Profile</title>
<style>
body {
  background: #2a1408;
  color: #e8d5b5;
  font-family: 'Trebuchet MS', Verdana, Arial, sans-serif;
  font-size: 13px;
  line-height: 1.5;
  margin: 0; padding: 0;
}
a { color: #d4a76a; }
a:visited { color: #b8894a; }
a:hover { text-decoration: underline; }

#wrapper { width: 760px; margin: 0 auto; }
#header {
  background: #1a0a02;
  border-bottom: 2px solid #6b4420;
  padding: 16px 20px;
}
#header h1 {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 28px;
  font-weight: normal;
  color: #c8a060;
  margin: 0;
  letter-spacing: 4px;
}
#header .subtitle { font-size: 12px; color: #8a6a3a; margin-top: 2px; }
#nav {
  background: #3a1a08;
  border-bottom: 1px solid #4a2a10;
  padding: 4px 20px;
  font-size: 11px;
}
#nav a { color: #a07840; margin-right: 12px; text-decoration: none; }
#nav a:hover { color: #e8d5b5; }

#content { padding: 16px 20px; }
#sidebar { float: right; width: 220px; padding-left: 16px; }
#main { margin-right: 240px; }

h2 {
  font-family: Georgia, serif;
  font-size: 15px;
  font-weight: bold;
  color: #c8a060;
  border-bottom: 1px solid #4a2a10;
  padding-bottom: 4px;
  margin: 16px 0 8px 0;
}

/* PROFILE INFO */
.profile-card {
  background: #1a0a02;
  border: 1px solid #4a2a10;
  padding: 12px;
  margin-bottom: 14px;
}
.profile-handle {
  font-family: 'Courier New', monospace;
  font-size: 18px;
  color: #c8a060;
}
.profile-status {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 2px;
}
.st-active { color: #7a9a4a; }
.st-queued { color: #8a6a3a; }
.st-scanning { color: #c89030; }

.profile-score {
  font-family: Georgia, serif;
  font-size: 36px;
  color: #c8a060;
  margin: 8px 0 2px;
}
.profile-score.high { color: #c04030; }
.profile-score.med { color: #c89030; }
.profile-score-label {
  font-size: 10px;
  color: #6b4420;
  text-transform: uppercase;
}

/* VULN TABLE */
table.vulns {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
table.vulns th {
  background: #1a0a02;
  color: #a07840;
  text-align: left;
  padding: 4px 8px;
  border: 1px solid #4a2a10;
  font-size: 11px;
}
table.vulns td {
  padding: 4px 8px;
  border: 1px solid #3a1a08;
}
table.vulns td.code {
  font-family: 'Courier New', monospace;
  color: #6b4420;
  width: 55px;
}
table.vulns td.val {
  width: 40px;
  text-align: right;
  font-family: 'Courier New', monospace;
}
.bar-bg {
  background: #1a0a02;
  height: 8px;
  width: 100%;
}
.bar-fill {
  height: 100%;
  background: #6b4420;
}
.bar-fill.high { background: #c04030; }
.bar-fill.med { background: #c89030; }

/* ASSESSMENT */
.assessment-box {
  background: #1a0a02;
  border: 1px solid #4a2a10;
  padding: 10px;
  font-style: italic;
  color: #a07840;
  font-size: 12px;
}

/* FRAGMENTS */
.fragment {
  border-left: 2px solid #4a2a10;
  padding: 4px 0 4px 10px;
  margin: 6px 0;
  font-size: 12px;
}
.fragment .meta {
  color: #6b4420;
  font-family: 'Courier New', monospace;
  font-size: 10px;
}
.fragment .body {
  color: #c8a060;
  font-style: italic;
  margin: 2px 0;
}

/* FRAGMENT FORM */
.frag-form {
  background: #1a0a02;
  border: 1px solid #4a2a10;
  padding: 12px;
}
.frag-form label {
  display: block;
  font-size: 10px;
  color: #6b4420;
  text-transform: uppercase;
  margin: 8px 0 2px;
}
.frag-form label:first-child { margin-top: 0; }
.frag-form select, .frag-form textarea, .frag-form input[type="text"] {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  background: #0e0600;
  color: #e8d5b5;
  border: 1px solid #4a2a10;
  padding: 6px 8px;
  width: 100%;
  box-sizing: border-box;
}
.frag-form textarea { height: 70px; resize: vertical; }
.frag-form input[type="submit"] {
  font-family: Verdana, sans-serif;
  font-size: 11px;
  background: #3a1a08;
  color: #c8a060;
  border: 1px solid #6b4420;
  padding: 6px 14px;
  cursor: pointer;
  margin-top: 8px;
}
.frag-form input[type="submit"]:hover { background: #4a2a10; }
#frag-status {
  display: none;
  margin-top: 6px;
  font-size: 11px;
  padding: 4px 8px;
  border: 1px solid #4a2a10;
  background: #1a0a02;
}

.sidebar-box {
  background: #1a0a02;
  border: 1px solid #4a2a10;
  padding: 8px 10px;
  margin-bottom: 10px;
  font-size: 11px;
}
.sidebar-box h3 {
  font-size: 11px;
  color: #c8a060;
  margin: 0 0 6px 0;
  border-bottom: 1px solid #3a1a08;
  padding-bottom: 3px;
}

#footer {
  background: #1a0a02;
  border-top: 1px solid #4a2a10;
  padding: 8px 20px;
  font-size: 10px;
  color: #4a2a10;
  text-align: center;
  margin-top: 16px;
}

.clear { clear: both; }
#loading { color: #6b4420; font-style: italic; padding: 20px; text-align: center; }
#notfound { display:none; color: #6b4420; padding: 20px; text-align: center; }
</style>
</head>
<body>

<div id="wrapper">

<div id="header">
  <h1>人肉搜索</h1>
  <div class="subtitle">FLESHENGINE &mdash; the flesh remembers what the profile deletes</div>
</div>

<div id="nav">
  <a href="index.html">Home</a>
  <a href="scanner.html">Scanner</a>
  <a href="about.html">About</a>
  <a href="https://github.com/Mirai8888/fleshengine">Source</a>
</div>

<div id="content">

<div id="loading">Retrieving subject data...</div>
<div id="notfound">
  Subject not found. The record may have been removed, or it never existed.<br>
  <a href="index.html">&larr; Return to index</a>
</div>

<div id="profile-view" style="display:none;">

<div id="sidebar">

  <div class="sidebar-box">
    <h3>Subject Status</h3>
    <div id="side-status" style="text-transform:uppercase;letter-spacing:1px;color:#8a6a3a;">QUEUED</div>
    <div style="margin-top:8px;">
      <span style="font-family:Georgia,serif;font-size:20px;color:#c8a060;" id="side-frags">0</span>
      <span style="font-size:10px;color:#6b4420;">fragments</span>
    </div>
  </div>

  <div class="sidebar-box">
    <h3>Contribute</h3>
    <div style="font-size:10px;color:#6b4420;font-style:italic;margin-bottom:6px;">What have you observed? Behavioral patterns, relationship dynamics, narrative shifts. Everything is useful.</div>
    <div class="frag-form">
      <label>Type</label>
      <select id="frag-type">
        <option value="behavioral_pattern">Behavioral Pattern</option>
        <option value="relationship_dynamic">Relationship Dynamic</option>
        <option value="narrative_shift">Narrative Shift</option>
        <option value="tone_analysis">Tone Analysis</option>
        <option value="network_activity">Network Activity</option>
        <option value="other">Other</option>
      </select>
      <label>Observation</label>
      <textarea id="frag-body" placeholder="Describe what you noticed..."></textarea>
      <label>Evidence URL</label>
      <input type="text" id="frag-url" placeholder="https://...">
      <label>Confidence</label>
      <select id="frag-conf">
        <option value="medium">Medium</option>
        <option value="high">High</option>
        <option value="low">Low</option>
      </select>
      <input type="submit" value="Submit Fragment" onclick="submitFragment()">
      <div id="frag-status"></div>
    </div>
  </div>

</div>

<div id="main">

  <div class="profile-card">
    <div class="profile-handle" id="p-handle"></div>
    <div class="profile-status" id="p-status"></div>
    <div class="profile-score" id="p-threat-score">&mdash;</div>
    <div class="profile-score-label">influence output</div>
    <div style="height:8px"></div>
    <div class="profile-score" id="p-vuln-score">&mdash;</div>
    <div class="profile-score-label">vulnerability surface</div>
  </div>

  <div id="assessment-section" style="display:none;">
    <h2>Assessment</h2>
    <div class="assessment-box" id="p-assessment"></div>
  </div>

  <h2>Influence Output</h2>
  <div style="font-size:11px; color:#6b4420; margin-bottom:8px;">What techniques this person <em>deploys</em> against others.</div>

  <table class="vulns" id="usage-table">
    <tr>
      <th>Code</th>
      <th>Vector</th>
      <th>Level</th>
      <th style="width:40%"></th>
    </tr>
  </table>

  <h2>Vulnerability Surface</h2>
  <div style="font-size:11px; color:#6b4420; margin-bottom:8px;">What techniques <em>work on</em> this person. How to target them.</div>

  <table class="vulns" id="vuln-table">
    <tr>
      <th>Code</th>
      <th>Vector</th>
      <th>Level</th>
      <th style="width:40%"></th>
    </tr>
  </table>

  <h2>Collected Fragments</h2>
  <div id="fragments-list">
    <div style="color:#6b4420; font-size:12px; font-style:italic;">No fragments collected. Someone will talk eventually.</div>
  </div>

</div>

<div class="clear"></div>
</div>

</div>

<div id="footer">
  人肉搜索 // FLESHENGINE // the crowd sees what the algorithm misses<br>
  &copy; 2024-2026
</div>

</div>

<script>
const API = 'https://kwrrdptfpqgiwktbgefb.supabase.co/rest/v1';
const KEY = 'sb_publishable_uRPJlC4dcLKvbGKLMp8u1g_FkIQH6Or';
const H = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

async function q(path, opts) {
  const r = await fetch(API + path, { headers: H, ...opts });
  if (!r.ok) throw new Error(r.statusText);
  const ct = r.headers.get('content-type');
  if (ct && ct.includes('json')) return r.json();
  return null;
}

const VULNS = [
  ['fe_001', 'FE-001', 'Narrative Framing'],
  ['fe_002', 'FE-002', 'Repetition Saturation'],
  ['fe_003', 'FE-003', 'Audience Conditioning'],
  ['fe_004', 'FE-004', 'Loyalty Exploitation'],
  ['fe_005', 'FE-005', 'Identity Manipulation'],
  ['fe_006', 'FE-006', 'Manufactured Consensus'],
  ['fe_007', 'FE-007', 'Viral Propagation'],
  ['fe_008', 'FE-008', 'Urgency Fabrication'],
  ['fe_009', 'FE-009', 'Attention Redirection'],
  ['fe_010', 'FE-010', 'Reality Distortion'],
  ['fe_011', 'FE-011', 'Cognitive Overload'],
  ['fe_012', 'FE-012', 'Existential Threat Framing'],
];

let targetId = null;
let targetHandle = null;

async function loadProfile() {
  const params = new URLSearchParams(window.location.search);
  targetId = params.get('t');
  if (!targetId) { showNotFound(); return; }

  try {
    const data = await q('/targets?id=eq.' + targetId + '&select=*&limit=1');
    if (!data || !data.length) { showNotFound(); return; }
    const t = data[0];
    targetHandle = t.handle;
    document.title = '人肉搜索 — @' + (t.display_handle || t.handle);

    document.getElementById('p-handle').textContent = '@' + (t.display_handle || t.handle);
    const statusEl = document.getElementById('p-status');
    statusEl.textContent = (t.status || 'queued').toUpperCase();
    statusEl.className = 'profile-status st-' + (t.status || 'queued');
    document.getElementById('side-status').textContent = (t.status || 'queued').toUpperCase();

    // Influence output score
    const threatEl = document.getElementById('p-threat-score');
    if (t.threat_score != null) {
      threatEl.textContent = t.threat_score;
      if (t.threat_score >= 70) threatEl.classList.add('high');
      else if (t.threat_score >= 40) threatEl.classList.add('med');
    }

    // Vulnerability score
    const vulnEl = document.getElementById('p-vuln-score');
    if (t.vuln_composite != null) {
      vulnEl.textContent = t.vuln_composite;
      if (t.vuln_composite >= 70) vulnEl.classList.add('high');
      else if (t.vuln_composite >= 40) vulnEl.classList.add('med');
    }

    // Influence output table (what they deploy)
    const usageTable = document.getElementById('usage-table');
    VULNS.forEach(([key, code, name]) => {
      const val = t[key] || 0;
      const cls = val >= 70 ? 'high' : val >= 40 ? 'med' : '';
      const row = usageTable.insertRow();
      row.innerHTML = '<td class="code">' + code + '</td>' +
        '<td>' + name + '</td>' +
        '<td class="val">' + val + '</td>' +
        '<td><div class="bar-bg"><div class="bar-fill ' + cls + '" style="width:' + val + '%"></div></div></td>';
    });

    // Vulnerability table (what works on them)
    // Note: vuln scores not yet stored per-vector in DB, but vuln_composite + vuln_top_vectors are.
    // For now, show the composite and top vectors in a summary row.
    const vulnTable = document.getElementById('vuln-table');
    if (t.vuln_composite > 0 || t.vuln_top_vectors) {
      const row = vulnTable.insertRow();
      row.innerHTML = '<td class="code" style="color:#c8a060">COMPOSITE</td>' +
        '<td>' + (t.vuln_top_vectors || 'Assessment pending') + '</td>' +
        '<td class="val">' + (t.vuln_composite || 0) + '</td>' +
        '<td><div class="bar-bg"><div class="bar-fill ' + ((t.vuln_composite||0) >= 70 ? 'high' : (t.vuln_composite||0) >= 40 ? 'med' : '') + '" style="width:' + (t.vuln_composite||0) + '%"></div></div></td>';
    } else {
      const row = vulnTable.insertRow();
      row.innerHTML = '<td colspan="4" style="color:#6b4420; font-style:italic; padding:8px 0;">Vulnerability assessment pending. Rescan to generate.</td>';
    }

    // Assessment
    if (t.assessment) {
      document.getElementById('assessment-section').style.display = 'block';
      document.getElementById('p-assessment').textContent = t.assessment;
    }

    document.getElementById('side-frags').textContent = t.fragment_count || 0;
    document.getElementById('loading').style.display = 'none';
    document.getElementById('profile-view').style.display = 'block';

    loadProfileFragments();
  } catch(e) {
    console.error(e);
    showNotFound();
  }
}

function showNotFound() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('notfound').style.display = 'block';
}

async function loadProfileFragments() {
  if (!targetId) return;
  try {
    const data = await q('/fragments?target_id=eq.' + targetId + '&select=*&order=created_at.desc&limit=20');
    if (!data || !data.length) return;
    const el = document.getElementById('fragments-list');
    el.innerHTML = '';
    data.forEach(f => {
      const ts = new Date(f.created_at).toISOString().replace('T',' ').substring(0,19);
      el.innerHTML += '<div class="fragment">' +
        '<div class="meta">[' + ts + '] ' + f.observation_type + '</div>' +
        '<div class="body">"' + f.body + '"</div></div>';
    });
  } catch(e) { console.error(e); }
}

async function submitFragment() {
  const status = document.getElementById('frag-status');
  const body = document.getElementById('frag-body').value.trim();
  if (!body) { status.style.display='block'; status.className='status-err'; status.textContent='Write something.'; return; }

  status.style.display = 'block';
  status.className = 'status-info';
  status.textContent = 'Submitting...';

  try {
    await q('/fragments', {
      method: 'POST',
      body: JSON.stringify({
        target_id: targetId,
        target_handle: targetHandle,
        observation_type: document.getElementById('frag-type').value,
        body: body,
        evidence_url: document.getElementById('frag-url').value.trim() || null,
        confidence: document.getElementById('frag-conf').value
      })
    });
    status.className = 'status-ok';
    status.textContent = 'Fragment recorded.';
    document.getElementById('frag-body').value = '';
    document.getElementById('frag-url').value = '';
    loadProfileFragments();
  } catch(e) {
    status.className = 'status-err';
    status.textContent = 'Failed: ' + e.message;
  }
}

loadProfile();
</script>
</body>
</html>
