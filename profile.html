<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>人肉搜索 — Profile</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap');

body {
  background: #1a0a02;
  color: #c8a878;
  font-family: 'EB Garamond', Georgia, serif;
  font-size: 16px;
  line-height: 1.6;
  margin: 0; padding: 0;
}
::selection { background: #6b4420; color: #fee6cf; }
a { color: #bd965d; text-decoration: none; }
a:hover { color: #fee6cf; }

#wrapper { max-width: 800px; margin: 0 auto; min-height: 100vh; }

#header {
  border-bottom: 1px solid #3a1a08;
  padding: 40px 24px 20px;
  text-align: center;
}
#header h1 {
  font-family: 'Cinzel', serif;
  font-size: 36px;
  font-weight: 400;
  color: #bd965d;
  margin: 0;
  letter-spacing: 8px;
}
#header .sub {
  font-size: 11px;
  color: #5a3a18;
  letter-spacing: 6px;
  text-transform: uppercase;
  margin-top: 6px;
}
#nav {
  text-align: center;
  padding: 10px;
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 3px;
  text-transform: uppercase;
  border-bottom: 1px solid #2a1408;
}
#nav a { color: #6b4420; margin: 0 14px; }
#nav a:hover { color: #bd965d; }

#content { padding: 30px 24px; }

h2 {
  font-family: 'Cinzel', serif;
  font-size: 14px;
  font-weight: 400;
  color: #6b4420;
  letter-spacing: 4px;
  text-transform: uppercase;
  border-bottom: 1px solid #2a1408;
  padding-bottom: 6px;
  margin: 30px 0 14px;
}

/* PROFILE HEADER */
.profile-header {
  background: #0e0600;
  border: 1px solid #2a1408;
  padding: 24px;
  margin-bottom: 24px;
}
.profile-handle {
  font-family: 'Courier New', monospace;
  font-size: 22px;
  color: #bd965d;
}
.profile-status {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-top: 4px;
}
.status-active { color: #6b8a3a; }
.status-queued { color: #6b4420; }
.status-scanning { color: #a07840; }

.profile-score {
  font-family: 'Cinzel', serif;
  font-size: 48px;
  color: #bd965d;
  margin: 16px 0 4px;
  line-height: 1;
}
.profile-score.high { color: #8a3a2a; }
.profile-score.med { color: #a07840; }
.profile-score-label {
  font-size: 10px;
  color: #5a3a18;
  text-transform: uppercase;
  letter-spacing: 2px;
}

/* VULNERABILITY BARS */
.vuln-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.vuln-item {
  background: #0e0600;
  border: 1px solid #2a1408;
  padding: 10px 12px;
}
.vuln-code {
  font-family: 'Courier New', monospace;
  font-size: 10px;
  color: #5a3a18;
  letter-spacing: 1px;
}
.vuln-name {
  font-size: 12px;
  color: #c8a878;
  margin: 2px 0 6px;
}
.vuln-bar-bg {
  background: #2a1408;
  height: 4px;
  border-radius: 2px;
  overflow: hidden;
}
.vuln-bar-fill {
  height: 100%;
  background: #6b4420;
  transition: width 0.8s ease;
}
.vuln-bar-fill.high { background: #8a3a2a; }
.vuln-bar-fill.med { background: #a07840; }
.vuln-val {
  font-family: 'Courier New', monospace;
  font-size: 10px;
  color: #5a3a18;
  float: right;
  margin-top: -14px;
}

/* ASSESSMENT */
.assessment {
  background: #0e0600;
  border: 1px solid #2a1408;
  padding: 16px;
  font-style: italic;
  color: #a08858;
  font-size: 15px;
}

/* FRAGMENTS */
.fragment {
  border-left: 2px solid #2a1408;
  padding: 6px 0 6px 14px;
  margin: 10px 0;
}
.fragment .ts {
  font-family: 'Courier New', monospace;
  font-size: 10px;
  color: #3a1a08;
}
.fragment .type {
  font-size: 10px;
  color: #5a3a18;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.fragment .body {
  color: #c8a878;
  font-style: italic;
  margin: 3px 0;
  font-size: 14px;
}

/* FRAGMENT SUBMIT */
.frag-form {
  background: #0e0600;
  border: 1px solid #2a1408;
  padding: 16px;
}
.frag-form label {
  display: block;
  font-size: 11px;
  color: #5a3a18;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
  margin-top: 10px;
}
.frag-form label:first-child { margin-top: 0; }
.frag-form select, .frag-form textarea, .frag-form input[type="text"] {
  font-family: 'EB Garamond', Georgia, serif;
  font-size: 14px;
  background: #0a0400;
  color: #c8a878;
  border: 1px solid #3a1a08;
  padding: 6px 8px;
  width: 100%;
  box-sizing: border-box;
}
.frag-form select { font-size: 13px; }
.frag-form textarea { height: 80px; resize: vertical; }
.frag-form button {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 2px;
  background: none;
  color: #6b4420;
  border: 1px solid #3a1a08;
  padding: 8px 18px;
  cursor: pointer;
  text-transform: uppercase;
  margin-top: 12px;
}
.frag-form button:hover { color: #bd965d; border-color: #6b4420; }
#frag-status {
  display: none;
  margin-top: 10px;
  font-size: 13px;
  padding: 6px;
  border-left: 2px solid #3a1a08;
}

.empty-state {
  color: #3a1a08;
  font-style: italic;
  font-size: 13px;
  padding: 14px 0;
}

#footer {
  border-top: 1px solid #2a1408;
  padding: 20px 24px;
  text-align: center;
  font-size: 10px;
  color: #2a1408;
  letter-spacing: 2px;
}

@keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
.loading { animation: pulse 1.5s ease-in-out infinite; color: #3a1a08; font-style: italic; }

@media (max-width: 700px) {
  .vuln-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="wrapper">

<div id="header">
  <h1>人肉搜索</h1>
  <div class="sub">the flesh remembers what the profile deletes</div>
</div>

<div id="nav">
  <a href="index.html">Index</a>
  <a href="scanner.html">Scanner</a>
  <a href="about.html">About</a>
  <a href="https://github.com/Mirai8888/fleshengine">Source</a>
</div>

<div id="content">

  <div id="profile-loading" class="loading" style="text-align:center;padding:40px;">Retrieving subject data...</div>
  <div id="profile-notfound" style="display:none;text-align:center;padding:40px;">
    <div style="font-family:Cinzel,serif;font-size:16px;color:#6b4420;">Subject not found.</div>
    <div style="margin-top:8px;font-size:13px;color:#3a1a08;">The record may have been removed, or it never existed.</div>
    <div style="margin-top:14px;"><a href="index.html">&larr; Return to index</a></div>
  </div>

  <div id="profile-content" style="display:none;">

    <div class="profile-header">
      <div class="profile-handle" id="p-handle"></div>
      <div class="profile-status" id="p-status"></div>
      <div class="profile-score" id="p-score">&mdash;</div>
      <div class="profile-score-label">vulnerability composite</div>
    </div>

    <h2>Vulnerability Surface</h2>
    <div class="vuln-grid" id="vuln-grid"></div>

    <div id="assessment-section" style="display:none;">
      <h2>Assessment</h2>
      <div class="assessment" id="p-assessment"></div>
    </div>

    <h2>Collected Fragments</h2>
    <div id="fragments-list">
      <div class="empty-state">No one has contributed yet. Be the first.</div>
    </div>

    <h2>Submit Fragment</h2>
    <div class="frag-form">
      <div style="font-size:12px;color:#5a3a18;font-style:italic;margin-bottom:10px;">What have you observed? Behavioral patterns, relationship dynamics, narrative shifts. Everything is useful. Nothing is too small.</div>
      <label>Observation Type</label>
      <select id="frag-type">
        <option value="behavioral_pattern">Behavioral Pattern</option>
        <option value="relationship_dynamic">Relationship Dynamic</option>
        <option value="narrative_shift">Narrative Shift</option>
        <option value="tone_analysis">Tone Analysis</option>
        <option value="network_activity">Network Activity</option>
        <option value="other">Other</option>
      </select>
      <label>Observation</label>
      <textarea id="frag-body" placeholder="Describe what you noticed..."></textarea>
      <label>Evidence URL (optional)</label>
      <input type="text" id="frag-url" placeholder="https://...">
      <label>Confidence</label>
      <select id="frag-conf">
        <option value="medium">Medium</option>
        <option value="high">High</option>
        <option value="low">Low</option>
      </select>
      <button onclick="submitFragment()">Submit Fragment</button>
      <div id="frag-status"></div>
    </div>

  </div>

</div>

<div id="footer">
  人肉搜索 &middot; FLESHENGINE &middot; the crowd sees what the algorithm misses
</div>

</div>

<script>
const API = 'https://kwrrdptfpqgiwktbgefb.supabase.co/rest/v1';
const KEY = 'sb_publishable_uRPJlC4dcLKvbGKLMp8u1g_FkIQH6Or';
const H = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

async function q(path, opts) {
  const r = await fetch(API + path, { headers: H, ...opts });
  if (!r.ok) throw new Error(r.statusText);
  const ct = r.headers.get('content-type');
  if (ct && ct.includes('json')) return r.json();
  return null;
}

const VULNS = [
  ['fe_001', 'FE-001', 'Narrative Framing'],
  ['fe_002', 'FE-002', 'Repetition Saturation'],
  ['fe_003', 'FE-003', 'Audience Conditioning'],
  ['fe_004', 'FE-004', 'Loyalty Exploitation'],
  ['fe_005', 'FE-005', 'Identity Manipulation'],
  ['fe_006', 'FE-006', 'Manufactured Consensus'],
  ['fe_007', 'FE-007', 'Viral Propagation'],
  ['fe_008', 'FE-008', 'Urgency Fabrication'],
  ['fe_009', 'FE-009', 'Attention Redirection'],
  ['fe_010', 'FE-010', 'Reality Distortion'],
  ['fe_011', 'FE-011', 'Cognitive Overload'],
  ['fe_012', 'FE-012', 'Existential Threat Framing'],
];

let targetId = null;
let targetHandle = null;

async function loadProfile() {
  const params = new URLSearchParams(window.location.search);
  targetId = params.get('t');
  if (!targetId) { showNotFound(); return; }

  try {
    const data = await q('/targets?id=eq.' + targetId + '&select=*&limit=1');
    if (!data || !data.length) { showNotFound(); return; }
    const t = data[0];
    targetHandle = t.handle;
    document.title = '人肉搜索 — @' + (t.display_handle || t.handle);

    document.getElementById('p-handle').textContent = '@' + (t.display_handle || t.handle);
    const statusEl = document.getElementById('p-status');
    statusEl.textContent = (t.status || 'queued').toUpperCase();
    statusEl.className = 'profile-status status-' + (t.status || 'queued');

    const scoreEl = document.getElementById('p-score');
    if (t.threat_score != null) {
      scoreEl.textContent = t.threat_score;
      if (t.threat_score >= 70) scoreEl.classList.add('high');
      else if (t.threat_score >= 40) scoreEl.classList.add('med');
    }

    // Vulnerability grid
    const grid = document.getElementById('vuln-grid');
    grid.innerHTML = '';
    VULNS.forEach(([key, code, name]) => {
      const val = t[key] || 0;
      const cls = val >= 70 ? 'high' : val >= 40 ? 'med' : '';
      grid.innerHTML += '<div class="vuln-item">' +
        '<span class="vuln-code">' + code + '</span>' +
        '<div class="vuln-name">' + name + '</div>' +
        '<div class="vuln-bar-bg"><div class="vuln-bar-fill ' + cls + '" style="width:' + val + '%"></div></div>' +
        '<span class="vuln-val">' + val + '</span>' +
        '</div>';
    });

    // Assessment
    if (t.assessment) {
      document.getElementById('assessment-section').style.display = 'block';
      document.getElementById('p-assessment').textContent = t.assessment;
    }

    document.getElementById('profile-loading').style.display = 'none';
    document.getElementById('profile-content').style.display = 'block';

    loadProfileFragments();
  } catch(e) {
    console.error(e);
    showNotFound();
  }
}

function showNotFound() {
  document.getElementById('profile-loading').style.display = 'none';
  document.getElementById('profile-notfound').style.display = 'block';
}

async function loadProfileFragments() {
  if (!targetId) return;
  try {
    const data = await q('/fragments?target_id=eq.' + targetId + '&select=*&order=created_at.desc&limit=20');
    if (!data || !data.length) return;
    const el = document.getElementById('fragments-list');
    el.innerHTML = '';
    data.forEach(f => {
      const ts = new Date(f.created_at).toISOString().replace('T',' ').substring(0,16);
      el.innerHTML += '<div class="fragment">' +
        '<span class="ts">' + ts + '</span> <span class="type">' + f.observation_type + '</span>' +
        '<div class="body">"' + f.body + '"</div>' +
        '</div>';
    });
  } catch(e) { console.error(e); }
}

async function submitFragment() {
  const status = document.getElementById('frag-status');
  const body = document.getElementById('frag-body').value.trim();
  if (!body) { status.style.display='block'; status.className='s-err'; status.textContent='Write something.'; return; }

  status.style.display = 'block';
  status.className = 's-info';
  status.textContent = 'Submitting...';

  try {
    await q('/fragments', {
      method: 'POST',
      body: JSON.stringify({
        target_id: targetId,
        target_handle: targetHandle,
        observation_type: document.getElementById('frag-type').value,
        body: body,
        evidence_url: document.getElementById('frag-url').value.trim() || null,
        confidence: document.getElementById('frag-conf').value
      })
    });
    status.className = 's-ok';
    status.textContent = 'Fragment recorded.';
    document.getElementById('frag-body').value = '';
    document.getElementById('frag-url').value = '';
    loadProfileFragments();
  } catch(e) {
    status.className = 's-err';
    status.textContent = 'Failed: ' + e.message;
  }
}

loadProfile();
</script>
</body>
</html>
